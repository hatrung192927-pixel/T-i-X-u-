<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>T√ÄI X·ªàU LIVE (1000+ lines)</title>
<style>
/* =========================
   THEME
   ========================= */
:root{
  --bg:#04121a;
  --panel:#071b28;
  --muted:#9fb0c8;
  --text:#e6f6ff;
  --accent:#22d3ee;
  --gold:#ffd966;
  --silver:#bfc6cc;
  --bronze:#d59f6a;
  --blue:#7ee3ff;
  --red:#f47272;
  --good:#34d399;
  --bad:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;background:linear-gradient(180deg,var(--bg),#02101a);color:var(--text)}
a{color:inherit}
.wrap{max-width:1240px;margin:120px auto;padding:18px}

/* top ticker */
#topTicker{position:fixed;top:0;left:0;right:0;height:36px;display:flex;align-items:center;background:rgba(1,6,12,0.92);z-index:9999;border-bottom:1px solid rgba(255,255,255,0.03);overflow:hidden}
#tickerTrack{display:inline-block;white-space:nowrap;padding-left:100%;animation:marquee 20s linear infinite;color:#ffd86b;font-weight:700;font-size:13px}
@keyframes marquee{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

/* header */
header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#3b82f6);display:grid;place-items:center;font-weight:900;font-size:20px;box-shadow:0 10px 30px rgba(34,211,238,.25)}
.title{font-size:20px;font-weight:800}
.subtitle{font-size:12px;color:var(--muted)}

/* buttons */
.btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;background:rgba(255,255,255,0.06);color:var(--text);font-weight:800;cursor:pointer;transition:transform .12s ease, box-shadow .2s ease, background .2s ease;box-shadow:0 6px 16px rgba(0,0,0,.25)}
.btn:hover{transform:translateY(-1px);background:rgba(255,255,255,0.12);box-shadow:0 10px 24px rgba(0,0,0,.35)}
.btn:active{transform:translateY(0);filter:brightness(0.95)}
.btn.primary{background:linear-gradient(135deg,#00d4ff,#007bff);color:#06121a;box-shadow:0 8px 26px rgba(0,123,255,.35)}
.btn.primary:hover{box-shadow:0 10px 32px rgba(0,123,255,.5)}
.btn.warn{background:linear-gradient(135deg,#f87171,#ef4444);color:#fff;box-shadow:0 8px 26px rgba(239,68,68,.35)}
.btn.warn:hover{box-shadow:0 12px 36px rgba(239,68,68,.55)}
.btn.success{background:linear-gradient(135deg,#34d399,#059669);color:#062013;box-shadow:0 8px 26px rgba(5,150,105,.35)}
.btn.success:hover{box-shadow:0 12px 36px rgba(5,150,105,.55)}

/* balance + rank */
.balance-rank{display:flex;align-items:center;gap:12px;padding:8px 12px;border-radius:12px;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:2px solid rgba(255,255,255,0.03)}
.balance-box{display:flex;flex-direction:column;align-items:flex-end}
.balance-box .label{font-size:12px;color:var(--muted)}
.balance-box .value{font-weight:900;font-size:16px}
.rank{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:10px;font-weight:800}
.rank .icon{font-size:22px}
.rank.diamond-bronze{background:var(--bronze);color:#000}
.rank.diamond-silver{background:var(--silver);color:#000}
.rank.diamond-gold{background:var(--gold);color:#000}
.rank.diamond-blue{background:var(--blue);color:#000}
.rank.diamond-red{background:var(--red);color:#000}

/* grid layout */
.grid{display:grid;grid-template-columns:2fr 1fr;gap:14px;margin-top:12px}
.panel{background:linear-gradient(180deg,var(--panel),#02121a);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.panel.small{padding:10px}
.dice-row{display:flex;gap:12px;align-items:center}
.die{width:86px;height:86px;border-radius:12px;background:linear-gradient(180deg,#0b1730,#071026);display:grid;place-items:center;font-size:40px;border:1px solid rgba(255,255,255,0.04);box-shadow:inset 0 8px 30px rgba(0,0,0,.35)}
.sum-block{text-align:right;margin-left:auto}
.sum-title{color:var(--muted);font-size:13px}
.sum-value{font-size:36px;font-weight:800}

/* countdown */
.countdown{height:12px;background:#041226;border-radius:8px;margin-top:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
.countdown-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#3b82f6);transition:width .3s linear}

/* chips */
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;background:linear-gradient(180deg,#ffd966,#f6c84c);color:#111;font-weight:800;border:1px solid rgba(0,0,0,0.08);cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.25);transition:transform .12s ease, box-shadow .2s ease}
.chip:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(0,0,0,.35)}
.chip.active{outline:3px solid rgba(255,209,102,0.25);transform:translateY(-4px)}
.chip .icon{width:28px;height:28px;display:grid;place-items:center;border-radius:8px;background:#fff;color:#000;font-size:16px}
.chip .amount{font-size:14px}

/* bets */
.bets-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
.bet{padding:14px;border-radius:12px;cursor:pointer;border:1px solid rgba(255,255,255,0.03);text-align:center;background:linear-gradient(180deg,#061226,#071428);position:relative;min-height:68px;display:flex;flex-direction:column;justify-content:center;transition:transform .12s ease, box-shadow .2s ease}
.bet:hover{transform:translateY(-3px);box-shadow:0 16px 36px rgba(0,0,0,.35)}
.bet .label{font-weight:800}
.bet .rate{font-size:12px;color:var(--muted)}
.badge-amt{position:absolute;right:8px;top:8px;background:rgba(255,209,102,0.95);color:#000;padding:4px 6px;border-radius:8px;font-weight:800}
.sum-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:8px;margin-top:10px}
.sum-btn{padding:10px;border-radius:10px;text-align:center;background:#061428;border:1px solid rgba(255,255,255,0.03);cursor:pointer;min-height:56px;display:flex;flex-direction:column;justify-content:center;transition:transform .12s ease, box-shadow .2s ease}
.sum-btn:hover{transform:translateY(-2px);box-shadow:0 12px 28px rgba(0,0,0,.25)}
.sum-btn .rate{font-size:12px;color:var(--muted)}
.sum-btn .val{font-weight:800}

/* show amount in number tile as badge inside tile content (not only top-right) */
.number-amount{display:block;margin-top:6px;font-weight:900;color:#ffd966;background:rgba(0,0,0,0.12);padding:4px 6px;border-radius:8px;display:inline-block;font-size:13px}

/* stats */
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}
.stat-card{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
.stat-card h4{margin:0;font-size:13px;color:var(--muted)}
.stat-card .big{font-size:20px;font-weight:800}

/* history */
.history{max-height:300px;overflow:auto;margin-top:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-top:1px solid rgba(255,255,255,0.02);font-size:13px}
thead th{color:var(--muted);border-top:none}

/* modal */
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:120}
.modal{width:920px;max-width:95%;background:#041225;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
.tabs{display:flex;gap:8px;margin-bottom:10px}
.tab{padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer}
.tab.active{background:linear-gradient(90deg,var(--accent),#059669);color:#061214}

/* CSKH */
#cskhBtn{position:fixed;right:18px;bottom:18px;background:linear-gradient(45deg,#00a2ff,#0066ff);color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;z-index:130;box-shadow:0 6px 20px rgba(0,0,0,0.4);font-weight:800}
#cskhPopup{position:fixed;right:18px;bottom:72px;width:320px;background:#071428;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);display:none;z-index:131}
#cskhPopup h3{margin:0 0 8px 0}
#cskhPopup .line{margin-bottom:6px}

/* notify */
.notify{position:fixed;right:18px;bottom:120px;background:rgba(2,6,23,0.85);padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);z-index:132;box-shadow:0 8px 30px rgba(2,6,23,0.6);display:none}

/* small */
.small-muted{font-size:12px;color:var(--muted)}
@media (max-width:980px){.grid{grid-template-columns:1fr}.wrap{margin-top:160px}}
</style>
</head>
<body>
  <!-- ticker -->
  <div id="topTicker"><div id="tickerTrack">ƒêang l·∫•y ho·∫°t ƒë·ªông...</div></div>

  <div class="wrap" role="main" aria-live="polite">
    <header>
      <div class="brand">
        <div class="logo">‚≠ê</div>
        <div>
          <div class="title">T√ÄI X·ªàU SICBO</div>
          <div class="subtitle">Phi√™n 60s </div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:12px">
        <div class="balance-rank" id="balanceRankWrap">
          <div class="balance-box">
            <div class="label">S·ªë d∆∞</div>
            <div class="value" id="balance">0</div>
          </div>
          <div id="rankBox" class="rank" title="H·∫°ng hi·ªán t·∫°i"><span class="icon" id="rankIcon">üíé</span><span id="rankName">Kim c∆∞∆°ng (ƒë·ªìng)</span></div>
        </div>
        <button id="openWalletBtn" class="btn primary" type="button">N·∫°p / R√∫t</button>
      </div>
    </header>

    <main class="grid">
      <!-- left -->
      <section class="panel" aria-label="B·∫£ng ch√≠nh">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="color:var(--muted);font-size:13px">X√∫c x·∫Øc</div>
          <div style="color:var(--muted);font-size:13px">V√°n #<span id="roundNo">0</span> ¬∑ K·∫øt qu·∫£ sau <span id="secLeft">60</span>s</div>
        </div>

        <div class="dice-row" style="margin-top:12px">
          <div class="die" id="d0">‚öÄ</div>
          <div class="die" id="d1">‚öÄ</div>
          <div class="die" id="d2">‚öÄ</div>
          <div class="sum-block">
            <div class="sum-title">T·ªïng</div>
            <div class="sum-value" id="sum">3</div>
          </div>
        </div>

        <div class="countdown"><div id="cdFill" class="countdown-fill"></div></div>

        <div style="display:flex;align-items:center;gap:10px;margin-top:12px">
          <div style="color:var(--muted);font-size:13px">M·ªánh gi√°</div>
          <div id="chipRow" class="chips" aria-hidden="false"></div>
        </div>

        <div id="betsArea">
          <div class="bets-grid" id="betsGrid" aria-label="B√†n c∆∞·ª£c"></div>
          <div class="sum-grid" id="sumGrid" aria-hidden="false"></div>

          <div style="display:flex;align-items:center;gap:8px;margin-top:12px">
            <button id="clearBets" class="btn" type="button">H·ªßy t·∫•t c·∫£</button>
            <button id="allInBtn" class="btn warn" type="button">All-in</button>
            <button id="confirmBets" class="btn primary" type="button">ƒê·ªìng √Ω</button>
            <div class="hint" style="margin-left:auto;color:var(--muted);font-size:12px">Ch·ªçn m·ªánh gi√° ‚Üí ch·ªçn √¥ ‚Üí b·∫•m ƒê·ªìng √Ω ƒë·ªÉ ch·ªët c∆∞·ª£c (kh√≥a cho phi√™n)</div>
          </div>
        </div>

        <div id="resultBox" style="margin-top:12px;color:var(--muted);font-weight:700"></div>
      </section>

      <!-- right -->
      <aside>
        <section class="panel small">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="color:var(--muted);font-size:13px">Th·ªëng k√™ ng∆∞·ªùi ch∆°i (c·∫≠p nh·∫≠t m·ªói phi√™n)</div>
            <div style="color:var(--muted);font-size:13px">Gi·ªù: <span id="nowClock">--:--:--</span></div>
          </div>

          <div class="stats-grid" style="margin-top:10px">
            <div class="stat-card">
              <h4>T√†i</h4>
              <div class="big" id="statTaiCount">0</div>
              <div class="small-muted" id="statTaiMoney">T·ªïng ti·ªÅn: 0 ƒë</div>
            </div>
            <div class="stat-card">
              <h4>X·ªâu</h4>
              <div class="big" id="statXiuCount">0</div>
              <div class="small-muted" id="statXiuMoney">T·ªïng ti·ªÅn: 0 ƒë</div>
            </div>
            <div class="stat-card">
              <h4>Ch·∫µn</h4>
              <div class="big" id="statChanCount">0</div>
              <div class="small-muted" id="statChanMoney">T·ªïng ti·ªÅn: 0 ƒë</div>
            </div>
            <div class="stat-card">
              <h4>L·∫ª</h4>
              <div class="big" id="statLeCount">0</div>
              <div class="small-muted" id="statLeMoney">T·ªïng ti·ªÅn: 0 ƒë</div>
            </div>
          </div>

          <div style="margin-top:8px">
            <div style="color:var(--muted);font-size:13px">T·ªïng ti·ªÅn c√°c c·ª≠a</div>
            <div style="font-weight:800;font-size:16px" id="grandTotal">0 ƒë</div>
          </div>
        </section>

        <section class="panel small" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="color:var(--muted);font-size:13px">L·ªãch s·ª≠ g·∫ßn ƒë√¢y</div>
            <div style="color:var(--muted);font-size:13px">Hi·ªÉn th·ªã 50 v√°n</div>
          </div>
          <div class="history">
            <table>
              <thead><tr><th>Th·ªùi gian</th><th>X√∫c x·∫Øc</th><th>T·ªïng</th><th>Tr·∫£</th><th>L√£i/L·ªó</th></tr></thead>
              <tbody id="historyTbl"></tbody>
            </table>
          </div>
        </section>

        <section class="panel small" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="color:var(--muted);font-size:13px">Top r√∫t ti·ªÅn h√¥m nay</div>
            <div style="color:var(--muted);font-size:13px" id="todayStr">--</div>
          </div>
          <ol id="topList" style="margin-top:8px;padding-left:16px"></ol>
        </section>
      </aside>
    </main>

    <div style="height:20px"></div>
    <footer style="text-align:center;color:var(--muted);font-size:12px"></footer>
  </div>

  <!-- CSKH -->
  <div id="cskhBtn" title="ChƒÉm s√≥c kh√°ch h√†ng" role="button">üí≥Ô∏é CSKH</div>
  <div id="cskhPopup" role="dialog" aria-modal="true">
    <h3>ChƒÉm S√≥c Kh√°ch H√†ng</h3>
    <div class="line"> <strong></strong></div>
    <div class="line">üí¨ Zalo: <strong>zalo.me/0348308336</strong></div>
    <div class="line"> <strong></strong></div>
    <div style="margin-top:8px;text-align:right"><button id="cskhClose" class="btn" type="button">ƒê√≥ng</button></div>
  </div>

  <div id="walletModalRoot"></div>
  <div id="notify" class="notify" role="alert" aria-hidden="true"></div>

<script>
/* ============================================================================
   Core config and helpers
   ============================================================================ */
const CHIP_VALUES = [1000,5000,10000,50000,100000,500000,1000000,5000000,10000000];
const ROUND_SECONDS = 60;
const SHOW_RESULT_SECONDS = 10;
const WIN_RATE = 0.70;
/* NOTE: ticker every 5s as requested */
const DEPOSIT_DELAY_MS = 30000; // 30s
const WITHDRAW_SUCCESS_MS = 60 * 60 * 1000; // 1h
const TICKER_INTERVAL_MS = 5000;
const NAMES = ['Nguy·ªÖn VƒÉn A','Tr·∫ßn Th·ªã B','L√™ VƒÉn C','Ph·∫°m Th·ªã D','Ho√†ng VƒÉn E','ƒê·∫∑ng Th·ªã F','V≈© Ng·ªçc G','B√πi Minh H','ƒê·ªó Th·ªã I','L√Ω VƒÉn J','Phan An K','H√† Th·ªã L'];
const SUM_PAYOUT = {}; for(let i=3;i<=18;i++) SUM_PAYOUT[i]=16;

/* persisted state via localStorage */
let balance = parseInt(localStorage.getItem('tx_balance')||'0',10);
let totalDeposited = parseInt(localStorage.getItem('tx_totalDeposited')||'0',10);
let history = JSON.parse(localStorage.getItem('tx_history')||'[]');
let txs = JSON.parse(localStorage.getItem('tx_txs')||'[]');
let pendingCredits = JSON.parse(localStorage.getItem('tx_pendingCredits')||'[]');
let pendingWithdraws = JSON.parse(localStorage.getItem('tx_pendingWithdraws')||'[]');
let roundNo = parseInt(localStorage.getItem('tx_roundNo')||'0',10);
let bets = []; // pending bets (before confirm)
let lockedBets = []; // confirmed bets for current round
let currentChip = CHIP_VALUES[2];
let isResultPhase = false;
let animInterval=null, countdownInterval=null, tickerInterval=null;

/* DOM helpers */
const $ = (s)=> document.querySelector(s);
const $$ = (s)=> document.querySelectorAll(s);
const fmt = n => (Number(n)||0).toLocaleString('vi-VN');
const rnd = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;
const sample = arr => arr[rnd(0,arr.length-1)];
const nowts = ()=> Date.now();

/* DOM refs used */
const balanceEl = $('#balance');
const rankBox = $('#rankBox');
const rankIcon = $('#rankBox .icon');
const rankName = $('#rankName');
const chipRow = $('#chipRow');
const betsGrid = $('#betsGrid');
const sumGrid = $('#sumGrid');
const dEls = [$('#d0'),$('#d1'),$('#d2')];
const sumEl = $('#sum');
const secLeftEl = $('#secLeft');
const cdFill = $('#cdFill');
const historyTbl = $('#historyTbl');
const tickerTrack = $('#tickerTrack');
const statTaiCount = $('#statTaiCount');
const statXiuCount = $('#statXiuCount');
const statChanCount = $('#statChanCount');
const statLeCount = $('#statLeCount');
const statTaiMoney = $('#statTaiMoney');
const statXiuMoney = $('#statXiuMoney');
const statChanMoney = $('#statChanMoney');
const statLeMoney = $('#statLeMoney');
const grandTotalEl = $('#grandTotal');
const roundNoEl = $('#roundNo');
const nowClock = $('#nowClock');
const topList = $('#topList');
const todayStr = $('#todayStr');
const resultBox = $('#resultBox');

/* persist function */
function saveState(){
  localStorage.setItem('tx_balance', String(balance));
  localStorage.setItem('tx_totalDeposited', String(totalDeposited));
  localStorage.setItem('tx_history', JSON.stringify(history));
  localStorage.setItem('tx_txs', JSON.stringify(txs));
  localStorage.setItem('tx_pendingCredits', JSON.stringify(pendingCredits));
  localStorage.setItem('tx_pendingWithdraws', JSON.stringify(pendingWithdraws));
  localStorage.setItem('tx_roundNo', String(roundNo));
}

/* ============================================================================
   Render UI pieces
   ============================================================================ */
function renderBalance(){ balanceEl.textContent = fmt(balance); updateRankUI(); }
function renderChips(){
  chipRow.innerHTML='';
  CHIP_VALUES.forEach(v=>{
    const btn = document.createElement('button'); btn.type='button';
    btn.className='chip'+(v===currentChip?' active':'');
    btn.innerHTML = `<span class="icon">üíµ</span><span class="amount">${fmt(v)}</span>`;
    btn.onclick = ()=> { currentChip = v; renderChips(); };
    chipRow.appendChild(btn);
  });
}

/* Setup bet grid (T√†i/X·ªâu/Ch·∫µn/L·∫ª and numbers 3..18) */
function setupBetGrid(){
  betsGrid.innerHTML='';
  const main = [
    {label:'T√ÄI', type:'bigSmall', key:'TAI'},
    {label:'X·ªàU', type:'bigSmall', key:'XIU'},
    {label:'CH·∫¥N', type:'oddEven', key:'CHAN'},
    {label:'L·∫∫', type:'oddEven', key:'LE'}
  ];
  main.forEach(b=>{
    const el = document.createElement('div');
    el.className='bet';
    el.dataset.type = b.type; el.dataset.key = b.key;
    el.innerHTML = `<div class="label">${b.label}</div><div class="rate">1:1</div>`;
    el.onclick = ()=> addPendingBet(b.type,b.key);
    betsGrid.appendChild(el);
  });

  // number buttons 3..18
  sumGrid.innerHTML='';
  for(let s=3;s<=18;s++){
    const el = document.createElement('div');
    el.className='sum-btn';
    el.dataset.type='sum'; el.dataset.key=s;
    el.innerHTML = `<div class="val">${s}</div><div class="rate">1:${SUM_PAYOUT[s]}</div><span class="number-amount" style="display:none" id="amt-${s}">0</span>`;
    el.onclick = ()=> addPendingBet('sum', s);
    sumGrid.appendChild(el);
  }
}

/* ============================================================================
   BET LOGIC
   ============================================================================ */
function findBet(list, type, key){
  return list.find(b => b.type===type && String(b.key)===String(key));
}

function addPendingBet(type, key){
  if(isResultPhase){ notify('ƒêang hi·ªÉn th·ªã k·∫øt qu·∫£; kh√¥ng th·ªÉ ƒë·∫∑t c∆∞·ª£c'); return; }
  if(!currentChip){ alert('Ch·ªçn m·ªánh gi√° tr∆∞·ªõc'); return; }
  const existing = findBet(bets, type, key);
  if(existing) existing.amount += currentChip;
  else bets.push({type, key, amount: currentChip});
  if(type==='sum'){
    const amtEl = document.getElementById('amt-'+key);
    if(amtEl){
      amtEl.style.display = 'inline-block';
      const total = bets.filter(x=>x.type==='sum' && String(x.key)===String(key)).reduce((s,x)=>s+x.amount,0);
      amtEl.textContent = fmt(total) + ' ƒë';
    }
  } else {
    const selector = `.bet[data-key="${key}"]`;
    const tile = document.querySelector(selector);
    if(tile){
      const pendingTotal = bets.filter(b=>b.type===type && String(b.key)===String(key)).reduce((s,b)=>s+b.amount,0);
      const locked = lockedBets.filter(b=>b.type===type && String(b.key)===String(key)).reduce((s,b)=>s+b.amount,0);
      tile.querySelectorAll('.in-tile-amt').forEach(n=>n.remove());
      const div = document.createElement('div'); div.className='in-tile-amt'; div.style.position='absolute'; div.style.left='8px'; div.style.bottom='8px'; div.style.background='rgba(0,0,0,0.35)'; div.style.padding='4px 6px'; div.style.borderRadius='8px'; div.style.fontWeight='800';
      div.textContent = fmt(pendingTotal + locked) + ' ƒë';
      tile.appendChild(div);
    }
  }
  renderBets(); updateTotals();
}

function renderBets(){
  document.querySelectorAll('.badge-amt, .in-tile-amt').forEach(n=>n.remove());
  for(let s=3;s<=18;s++){
    const amtEl = document.getElementById('amt-'+s);
    if(amtEl){ amtEl.style.display='none'; amtEl.textContent='0'; }
  }
  bets.forEach(b=>{
    if(b.type==='sum'){
      const amtEl = document.getElementById('amt-'+b.key);
      if(amtEl){ amtEl.style.display='inline-block'; const total = bets.filter(x=>x.type==='sum' && String(x.key)===String(b.key)).reduce((s,x)=>s+x.amount,0); amtEl.textContent = fmt(total) + ' ƒë'; }
    } else {
      const tile = document.querySelector(`.bet[data-key="${b.key}"]`);
      if(tile){ const div = document.createElement('div'); div.className='in-tile-amt'; div.style.position='absolute'; div.style.left='8px'; div.style.bottom='8px'; div.style.background='rgba(0,0,0,0.35)'; div.style.padding='4px 6px'; div.style.borderRadius='8px'; div.style.fontWeight='800'; const total = bets.filter(x=>x.type===b.type && String(x.key)===String(b.key)).reduce((s,x)=>s+x.amount,0); const lockedSum = lockedBets.filter(x=>x.type===b.type && String(x.key)===String(b.key)).reduce((s,x)=>s+x.amount,0); div.textContent = fmt(total + lockedSum) + ' ƒë'; tile.appendChild(div); }
    }
  });
  lockedBets.forEach(b=>{
    if(b.type==='sum'){
      const amtEl = document.getElementById('amt-'+b.key);
      if(amtEl){ amtEl.style.display='inline-block'; amtEl.textContent = fmt(b.amount) + ' ƒë'; amtEl.style.background = 'rgba(34,197,94,0.9)'; amtEl.style.color='#000'; }
    } else {
      const tile = document.querySelector(`.bet[data-key="${b.key}"]`);
      if(tile){ const badge = document.createElement('div'); badge.className='badge-amt'; badge.style.background='rgba(34,197,94,0.95)'; badge.textContent = fmt(b.amount); tile.appendChild(badge); }
    }
  });
}

function updateTotals(){
  const pendingSum = bets.reduce((s,b)=>s+b.amount,0);
  const lockedSum = lockedBets.reduce((s,b)=>s+b.amount,0);
  grandTotalEl.textContent = fmt(pendingSum + lockedSum) + ' ƒë';
}

document.getElementById('confirmBets').addEventListener('click', function(){
  const pendingSum = bets.reduce((s,b)=>s+b.amount,0);
  if(pendingSum <= 0){ alert('B·∫°n ch∆∞a ƒë·∫∑t c∆∞·ª£c'); return; }
  if(balance < pendingSum){ alert('S·ªë d∆∞ kh√¥ng ƒë·ªß ƒë·ªÉ ch·ªët c∆∞·ª£c'); return; }
  balance -= pendingSum;
  bets.forEach(b=>{
    const ex = findBet(lockedBets, b.type, b.key);
    if(ex) ex.amount += b.amount; else lockedBets.push({type:b.type, key:b.key, amount:b.amount});
  });
  bets = [];
  renderBets(); renderBalance(); saveState();
  notify('ƒê√£ ch·ªët c∆∞·ª£c cho phi√™n n√†y');
});

document.getElementById('clearBets').addEventListener('click', ()=>{
  if(isResultPhase){ notify('ƒêang hi·ªÉn th·ªã k·∫øt qu·∫£; kh√¥ng th·ªÉ h·ªßy c∆∞·ª£c'); return; }
  bets = []; renderBets(); updateTotals();
});

document.getElementById('allInBtn').addEventListener('click', ()=>{
  if(isResultPhase){ notify('ƒêang hi·ªÉn th·ªã k·∫øt qu·∫£; kh√¥ng th·ªÉ All-in'); return; }
  if(bets.length===0){ alert('Ch·ªçn √¥ c∆∞·ª£c tr∆∞·ªõc khi All-in'); return; }
  if(balance<=0){ alert('S·ªë d∆∞ kh√¥ng ƒë·ªß'); return; }
  const first = bets[0];
  const put = balance;
  balance = 0;
  const ex = findBet(lockedBets, first.type, first.key);
  if(ex) ex.amount += put; else lockedBets.push({type:first.type, key:first.key, amount:put});
  bets = bets.filter(b=>!(b.type===first.type && String(b.key)===String(first.key)));
  renderBets(); renderBalance(); saveState();
  notify(`All-in ${fmt(put)} ƒë v√†o ${first.key}`);
});

/* ============================================================================
   Dice animation, round control, finalize, payout calculation
   ============================================================================ */
function startDiceAnim(){
  stopDiceAnim();
  animInterval = setInterval(()=>{
    dEls.forEach(d=> d.textContent = '‚öÄ‚öÅ‚öÇ‚öÉ‚öÑ‚öÖ'.charAt(rnd(0,5)));
    sumEl.textContent = rnd(3,18);
  },80);
}
function stopDiceAnim(){ if(animInterval){ clearInterval(animInterval); animInterval=null; } }

let secLeft = ROUND_SECONDS;
let roundStart = null;
function startRound(){
  if(isResultPhase) return;
  secLeft = ROUND_SECONDS;
  roundStart = nowts();
  document.getElementById('roundNo').textContent = ++roundNo;
  saveState();
  startDiceAnim();
  randomizeStats();
  if(countdownInterval) clearInterval(countdownInterval);
  countdownInterval = setInterval(()=>{
    const elapsed = Math.floor((nowts() - roundStart) / 1000);
    const left = Math.max(0, ROUND_SECONDS - elapsed);
    secLeft = left;
    secLeftEl.textContent = left;
    const pct = Math.min(100, (elapsed/ROUND_SECONDS)*100);
    cdFill.style.width = pct + '%';
    processPendingCredits();
    processPendingWithdraws();
    if(left<=0){
      clearInterval(countdownInterval);
      finalizeRound();
    }
  }, 250);
}

/* Choose final sum with bias: WIN_RATE chance to favor lockedBets */
function chooseFinalSum(){
  const willFavor = Math.random() < WIN_RATE && lockedBets.length>0;
  if(willFavor){
    const sumBets = lockedBets.filter(b=>b.type==='sum').map(b=>Number(b.key));
    if(sumBets.length && Math.random()<0.6) return sample(sumBets);
    const hasTai = lockedBets.some(b=>b.type==='bigSmall' && b.key==='TAI');
    const hasXiu = lockedBets.some(b=>b.type==='bigSmall' && b.key==='XIU');
    const hasLe = lockedBets.some(b=>b.type==='oddEven' && b.key==='LE');
    const hasChan = lockedBets.some(b=>b.type==='oddEven' && b.key==='CHAN');
    const prefer=[];
    if(hasTai) prefer.push('TAI');
    if(hasXiu) prefer.push('XIU');
    if(hasLe) prefer.push('LE');
    if(hasChan) prefer.push('CHAN');
    if(prefer.length && Math.random()<0.85){
      const pick = sample(prefer);
      if(pick==='TAI') return rnd(11,17);
      if(pick==='XIU') return rnd(3,10);
      if(pick==='LE') return sample([5,7,9,11,13,15,17]);
      if(pick==='CHAN') return sample([4,6,8,10,12,14,16]);
    }
    return rnd(3,18);
  } else {
    for(let i=0;i<200;i++){
      const cand = rnd(3,18);
      const wouldWin = lockedBets.some(b=>{
        if(b.type==='sum') return Number(b.key)===cand;
        if(b.type==='bigSmall'){ const big = cand>=11 && cand<=17; return (b.key==='TAI' && big) || (b.key==='XIU' && !big); }
        if(b.type==='oddEven'){ const odd = cand%2===1; return (b.key==='LE' && odd) || (b.key==='CHAN' && !odd); }
        return false;
      });
      if(!wouldWin) return cand;
    }
    return rnd(3,18);
  }
}

function diceForSum(target){
  for(let i=0;i<5000;i++){
    const a=rnd(1,6), b=rnd(1,6), c=target-a-b;
    if(c>=1 && c<=6) return [a,b,c];
  }
  let a = Math.min(6, Math.max(1, Math.floor(target/3)));
  let b = Math.min(6, Math.max(1, Math.floor((target-a)/2)));
  let c = target-a-b;
  if(c<1){ c=1; b=target-a-c; }
  return [a,b,c];
}

function finalizeRound(){
  isResultPhase = true;
  stopDiceAnim();
  const finalSum = chooseFinalSum();
  const dice = diceForSum(finalSum);
  let payout = 0;
  const stake = lockedBets.reduce((s,b)=>s+b.amount,0);
  lockedBets.forEach(b=>{
    if(b.type==='bigSmall'){
      const isBig = finalSum>=11 && finalSum<=17;
      if((b.key==='TAI' && isBig) || (b.key==='XIU' && !isBig)) payout += b.amount*2;
    } else if(b.type==='oddEven'){
      const odd = finalSum%2===1;
      if((b.key==='LE' && odd) || (b.key==='CHAN' && !odd)) payout += b.amount*2;
    } else if(b.type==='sum'){
      if(Number(b.key)===finalSum){
        const rate = SUM_PAYOUT[finalSum] || 0;
        payout += b.amount*(rate+1);
      }
    }
  });
  const net = payout - stake;
  balance += payout;
  history.unshift({kind:'round', ts: nowts(), dice, sum: finalSum, payout, net});
  if(history.length>500) history.pop();

  dEls.forEach((el,i)=> el.textContent = '‚öÄ‚öÅ‚öÇ‚öÉ‚öÑ‚öÖ'.charAt(dice[i]-1));
  sumEl.textContent = finalSum;
  renderBalance(); renderHistory(); saveState();

  if(payout>0){
    addTicker(`${sample(NAMES)} th·∫Øng ${fmt(payout)} ƒë`);
    resultBox.textContent = `üéâ Ng∆∞·ªùi ch∆°i th·∫Øng t·ªïng ${fmt(payout)} ƒë ‚Äî K·∫øt qu·∫£ hi·ªÉn th·ªã ${SHOW_RESULT_SECONDS} gi√¢y`;
  } else {
    addTicker(`${sample(NAMES)} v·ª´a r√∫t ${fmt(rnd(10_000_000,8_000_000_000))} ƒë`);
    resultBox.textContent = `R·∫•t ti·∫øc ‚Äî Kh√¥ng c√≥ th·∫Øng c∆∞·ª£c. K·∫øt qu·∫£ hi·ªÉn th·ªã ${SHOW_RESULT_SECONDS} gi√¢y`;
  }

  setTimeout(()=>{
    lockedBets = [];
    isResultPhase = false;
    resultBox.textContent = '';
    renderBets();
    startRound();
  }, SHOW_RESULT_SECONDS * 1000);
}

/* ============================================================================
   Stats, ticker, top withdraws
   ============================================================================ */
function randomizeStats(){
  const taiPlayers = rnd(500,5000);
  const xiuPlayers = rnd(500,5000);
  const chanPlayers = rnd(500,5000);
  const lePlayers = rnd(500,5000);
  const taiMoney = Math.max(50_000_000, Math.floor((rnd(50_000_000,5_000_000_000)/1000) * taiPlayers));
  const xiuMoney = Math.max(50_000_000, Math.floor((rnd(50_000_000,5_000_000_000)/1000) * xiuPlayers));
  const chanMoney = Math.max(50_000_000, Math.floor((rnd(50_000_000,5_000_000_000)/1000) * chanPlayers));
  const leMoney = Math.max(50_000_000, Math.floor((rnd(50_000_000,5_000_000_000)/1000) * lePlayers));
  statTaiCount.textContent = fmt(taiPlayers);
  statXiuCount.textContent = fmt(xiuPlayers);
  statChanCount.textContent = fmt(chanPlayers);
  statLeCount.textContent = fmt(lePlayers);
  statTaiMoney.textContent = 'T·ªïng ti·ªÅn: ' + fmt(taiMoney) + ' ƒë';
  statXiuMoney.textContent = 'T·ªïng ti·ªÅn: ' + fmt(xiuMoney) + ' ƒë';
  statChanMoney.textContent = 'T·ªïng ti·ªÅn: ' + fmt(chanMoney) + ' ƒë';
  statLeMoney.textContent = 'T·ªïng ti·ªÅn: ' + fmt(leMoney) + ' ƒë';
  grandTotalEl.textContent = fmt(taiMoney + xiuMoney + chanMoney + leMoney) + ' ƒë';
}

function seedTicker(){
  const arr=[];
  for(let i=0;i<1;i++) arr.push(`${sample(NAMES)} v·ª´a r√∫t ${fmt(rnd(10_000_000,8_000_000_000))} ƒë`);
  tickerTrack.textContent = arr.join('  ‚Ä¢  ');
}
function addTicker(text){
  const current = tickerTrack.textContent || '';
  const parts = current.split('  ‚Ä¢  ').filter(Boolean);
  parts.push(text);
  while(parts.length>60) parts.shift();
  tickerTrack.textContent = parts.join('  ‚Ä¢  ');
}
function startTicker(){
  if(tickerInterval) clearInterval(tickerInterval);
  tickerInterval = setInterval(()=>{
    const t = rnd(1,3);
    if(t===1) addTicker(`${sample(NAMES)} v·ª´a r√∫t ${fmt(rnd(10_000_000,8_000_000_000))} ƒë`);
    else if(t===2) addTicker(`${sample(NAMES)} v·ª´a ƒë·∫∑t ${fmt(rnd(10000,5_000_000))} ƒë v√†o ${sample(['T√†i','X·ªâu','Ch·∫µn','L·∫ª'])}`);
    else addTicker(`${sample(NAMES)} v·ª´a th·∫Øng ${fmt(rnd(1_000_000,500_000_000))} ƒë`);
  }, TICKER_INTERVAL_MS);
}

/* top withdraws */
function buildTopWithdraws(){
  todayStr.textContent = new Date().toLocaleDateString('vi-VN');
  const arr=[];
  for(let i=0;i<12;i++) arr.push({name: sample(NAMES), amount: rnd(100_000_000, 10_000_000_000), ts: Date.now()-rnd(0,12*60*60*1000)});
  arr.sort((a,b)=>b.amount-a.amount);
  topList.innerHTML='';
  arr.forEach((it,idx)=>{
    const li = document.createElement('li');
    li.innerHTML = `<div style="display:flex;justify-content:space-between"><div style="display:flex;gap:8px"><span style="width:24px">${idx+1}.</span><strong>${it.name}</strong></div><div>+ ${fmt(it.amount)} ƒë</div></div>`;
    topList.appendChild(li);
  });
}

/* ============================================================================
   Wallet UI
   ============================================================================ */
const walletRoot = document.getElementById('walletModalRoot');
document.getElementById('openWalletBtn').addEventListener('click', openWallet);

function openWallet(){
  walletRoot.innerHTML = `
    <div class="modal-back" id="modalBack">
      <div class="modal" role="dialog" aria-modal="true">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="tabs">
            <div id="tabDep" class="tab active" role="button">N·∫°p ti·ªÅn</div>
            <div id="tabWit" class="tab" role="button">R√∫t ti·ªÅn</div>
          </div>
          <div><button id="closeWallet" class="btn" type="button">ƒê√≥ng</button></div>
        </div>
        <div id="modalBody"></div>
      </div>
    </div>
  `;
  document.getElementById('closeWallet').addEventListener('click', ()=> walletRoot.innerHTML='');
  document.getElementById('tabDep').addEventListener('click', ()=> { document.getElementById('tabDep').classList.add('active'); document.getElementById('tabWit').classList.remove('active'); showDeposit(); });
  document.getElementById('tabWit').addEventListener('click', ()=> { document.getElementById('tabWit').classList.add('active'); document.getElementById('tabDep').classList.remove('active'); showWithdraw(); });
  showDeposit();
}

function showDeposit(){
  const body = document.getElementById('modalBody');
  body.innerHTML = `
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:280px">
        <div style="margin-bottom:8px;color:var(--muted)">Chuy·ªÉn kho·∫£n t·ªõi</div>
        <div style="background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)">
          <div style="margin-bottom:6px"><div class="small-muted">Ng√¢n h√†ng</div><div style="font-weight:800">MB BANK</div></div>
          <div style="margin-bottom:6px"><div class="small-muted">S·ªë t√†i kho·∫£n</div><div style="font-weight:800">1108111111</div></div>
          <div style="margin-bottom:6px"><div class="small-muted">Ch·ªß t√†i kho·∫£n</div><div style="font-weight:800">DINH DUY QUANG</div></div>
        </div>
        <div style="margin-top:10px"><label class="small-muted">Ch·ªçn m·ªánh gi√°</label>
          <div id="depPresets" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px"></div>
        </div>
      </div>
      <div style="width:320px">
        <div style="margin-bottom:8px" class="small-muted">T·∫£i ·∫£nh x√°c nh·∫≠n (b·∫Øt bu·ªôc)</div>
        <input id="depFile" type="file" accept="image/*" />
        <div id="depPreview" style="margin-top:8px"></div>
        <div style="margin-top:10px"><button id="depSubmit" class="btn primary" type="button">G·ª≠i y√™u c·∫ßu n·∫°p</button></div>
        <div class="small-muted" style="margin-top:10px">* Ti·ªÅn s·∫Ω c·ªông sau 30s n·∫øu c√≥ ·∫£nh.</div>
      </div>
    </div>
  `;
  const presets = [10_000,50_000,100_000,1_000_000,2_000_000,10_000_000,50_000_000,100_000_000,200_000_000,1_000_000_000,5_000_000_000];
  const row = document.getElementById('depPresets');
  let selected = null;
  row.innerHTML='';
  presets.forEach(v=>{
    const b = document.createElement('button'); b.type='button'; b.className='btn'; b.textContent = fmt(v)+' ƒë';
    b.onclick = ()=> { selected=v; Array.from(row.children).forEach(ch=>ch.classList.remove('primary')); b.classList.add('primary'); };
    row.appendChild(b);
  });
  document.getElementById('depFile').addEventListener('change', e=>{
    const f = e.target.files[0]; const preview = document.getElementById('depPreview');
    if(!f){ preview.innerHTML=''; return; }
    const r = new FileReader();
    r.onload = ()=> preview.innerHTML = `<img src="${r.result}" style="max-width:100%;border-radius:8px;border:1px solid rgba(255,255,255,0.04)" />`;
    r.readAsDataURL(f);
  });
  document.getElementById('depSubmit').addEventListener('click', ()=> {
    if(!selected) return alert('Ch·ªçn m·ªánh gi√° tr∆∞·ªõc');
    const f = document.getElementById('depFile').files[0];
    if(!f) return alert('B·∫°n ph·∫£i t·∫£i ·∫£nh x√°c nh·∫≠n');
    const id = 'dep-'+Date.now();
    const tx = {id, kind:'deposit', amount:selected, status:'pending', created: nowts()};
    txs.unshift(tx);
    pendingCredits.push({id, amount:selected, ts: nowts(), credited:false});
    history.unshift({kind:'deposit', ts: nowts(), amount:selected, status:'pending'});
    saveState(); renderHistory();
    alert('Y√™u c·∫ßu n·∫°p ƒë√£ g·ª≠i. S·∫Ω c·ªông ti·ªÅn sau 30s n·∫øu h·ª£p l·ªá.');
    setTimeout(()=>{
      const pc = pendingCredits.find(p=>p.id===id);
      if(pc && !pc.credited){
        pc.credited=true;
        balance += pc.amount; totalDeposited += pc.amount;
        const t = txs.find(x=>x.id===id); if(t) t.status='approved';
        renderBalance(); updateRankUI(); saveState(); renderHistory(); notify(`N·∫°p +${fmt(pc.amount)} ƒë ƒë√£ v·ªÅ v√≠`);
      }
    }, DEPOSIT_DELAY_MS);
    walletRoot.innerHTML='';
  });
}

function showWithdraw(){
  const body = document.getElementById('modalBody');
  body.innerHTML = `
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:280px">
        <div style="margin-bottom:8px;color:var(--muted)">R√∫t ti·ªÅn</div>
        <div style="background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)">
          <div style="margin-bottom:6px"><label class="small-muted">Ng√¢n h√†ng</label><input id="witBank" type="text" placeholder="VD: MB BANK" /></div>
          <div style="margin-bottom:6px"><label class="small-muted">S·ªë t√†i kho·∫£n</label><input id="witAcc" type="text" /></div>
          <div style="margin-bottom:6px"><label class="small-muted">T√™n t√†i kho·∫£n</label><input id="witName" type="text" /></div>
          <div style="margin-bottom:6px"><label class="small-muted">S·ªë ti·ªÅn</label><input id="witAmount" type="number" value="0" /></div>
        </div>
        <div style="margin-top:10px"><button id="witSubmit" class="btn primary" type="button">G·ª≠i y√™u c·∫ßu r√∫t</button></div>
        <div class="small-muted" style="margin-top:10px">* Y√™u c·∫ßu x·ª≠ l√Ω v√† chuy·ªÉn th√†nh c√¥ng sau ~60 ph√∫t.</div>
      </div>
      <div style="width:320px">
        <div class="small-muted">Y√™u c·∫ßu r√∫t g·∫ßn ƒë√¢y</div>
        <div id="witList" style="margin-top:8px;max-height:300px;overflow:auto"></div>
      </div>
    </div>
  `;
  document.getElementById('witSubmit').addEventListener('click', ()=>{
    const bank = document.getElementById('witBank').value.trim();
    const acc = document.getElementById('witAcc').value.trim();
    const name = document.getElementById('witName').value.trim();
    const amount = parseInt(document.getElementById('witAmount').value||0,10);
    if(!bank||!acc||!name) return alert('Nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin');
    if(amount<=0) return alert('S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá');
    if(amount>balance) return alert('S·ªë d∆∞ kh√¥ng ƒë·ªß');
    const id = 'wit-'+Date.now();
    const w = {id, kind:'withdraw', amount, status:'processing', created: nowts(), meta:{bank,acc,name}, markAt: nowts()+WITHDRAW_SUCCESS_MS};
    txs.unshift(w); pendingWithdraws.push(w);
    balance -= amount; renderBalance(); saveState(); renderHistory();
    alert('Y√™u c·∫ßu r√∫t ƒë√£ g·ª≠i. Tr·∫°ng th√°i: ƒêang x·ª≠ l√Ω (s·∫Ω th√†nh c√¥ng sau ~1 gi·ªù).');
    walletRoot.innerHTML='';
  });
  renderWithdrawsList();
}
function renderWithdrawsList(){
  const box = document.getElementById('witList');
  const list = txs.filter(t=>t.kind==='withdraw').slice(0,20);
  if(!box) return;
  if(list.length===0){ box.innerHTML='<div class="small-muted">Ch∆∞a c√≥</div>'; return; }
  box.innerHTML = list.map(t=>{
    const st = t.status==='processing'? '<span style="background:#fde047;padding:4px 8px;border-radius:8px">ƒêang x·ª≠ l√Ω</span>'
              : t.status==='approved'? '<span style="background:#86efac;padding:4px 8px;border-radius:8px">Th√†nh c√¥ng</span>'
              : '<span style="background:#fca5a5;padding:4px 8px;border-radius:8px">T·ª´ ch·ªëi</span>';
    return `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)"><div style="display:flex;justify-content:space-between"><div>${new Date(t.created).toLocaleTimeString('vi-VN',{hour12:false})} ‚Ä¢ ${t.meta? t.meta.bank : ''}</div><div>${st}</div></div><div style="font-weight:800">-${fmt(t.amount)} ƒë</div></div>`;
  }).join('');
}

/* ============================================================================
   pending processors: deposits & withdraws
   ============================================================================ */
function processPendingCredits(){
  const nowt = nowts();
  pendingCredits.forEach(p=>{
    if(!p.credited && nowt - p.ts >= DEPOSIT_DELAY_MS){
      p.credited=true;
      balance += p.amount; totalDeposited += p.amount;
      const tx = txs.find(x=>x.id===p.id); if(tx) tx.status='approved';
      renderBalance(); updateRankUI(); saveState(); renderHistory(); notify(`N·∫°p +${fmt(p.amount)} ƒë ƒë√£ v·ªÅ v√≠`);
    }
  });
}
function processPendingWithdraws(){
  const nowt = nowts();
  let changed=false;
  pendingWithdraws.forEach(w=>{
    if(w.status==='processing' && nowt >= (w.markAt||0)){
      w.status='approved';
      const tx = txs.find(x=>x.id===w.id); if(tx) tx.status='approved';
      changed=true;
      notify(`R√∫t ${fmt(w.amount)} ƒë ƒë√£ x·ª≠ l√Ω th√†nh c√¥ng`);
    }
  });
  if(changed){ saveState(); renderWithdrawsList(); renderHistory(); }
}

/* ============================================================================
   history render
   ============================================================================ */
function renderHistory(){
  historyTbl.innerHTML='';
  history.slice(0,60).forEach(h=>{
    const tr = document.createElement('tr');
    const t = new Date(h.ts).toLocaleTimeString('vi-VN',{hour12:false});
    const dice = (h.dice||[]).map(d=>'‚öÄ‚öÅ‚öÇ‚öÉ‚öÑ‚öÖ'.charAt(d-1)).join(' ');
    const payout = fmt(h.payout||0);
    const net = (h.net||0);
    tr.innerHTML = `<td>${t}</td><td>${dice}</td><td>${h.sum||''}</td><td>${payout} ƒë</td><td style="color:${net>=0? 'var(--good)':'var(--bad)'}">${net>=0?'+':''}${fmt(net)} ƒë</td>`;
    historyTbl.appendChild(tr);
  });
}

/* ============================================================================
   Rank UI update ‚Äî 5 diamond colors: bronze, silver, gold, blue, red
   ============================================================================ */
function getRank(){
  // thresholds c·ª© gi·ªØ nh∆∞ c≈©, ch·ªâ ƒë·ªïi m√†u/nh√£n
  if(totalDeposited >= 5_000_000_000) return {key:'diamond-red', name:'Top', icon:'üëë', className:'rank diamond-red'};
  if(totalDeposited >= 1_000_000_000) return {key:'diamond-blue', name:'Kim c∆∞∆°ng ', icon:'üíé', className:'rank diamond-blue'};
  if(totalDeposited >= 100_000_000) return {key:'diamond-gold', name:' ƒê√° Qu√Ω ', icon:'üíç', className:'rank diamond-gold'};
  if(totalDeposited >= 10_000_000) return {key:'diamond-silver', name:'V√†ng', icon:'ü•á', className:'rank diamond-silver'};
  if(totalDeposited >= 1_000_000) return {key:'diamond-bronze', name:' B·∫°c ', icon:'ü•à', className:'rank diamond-bronze'};
  return {key:'none', name:'ƒê·ªìng', icon:'ü•â', className:'rank'};
}
function updateRankUI(){
  const r = getRank();
  rankIcon.textContent = r.icon;
  rankName.textContent = r.name;
  rankBox.className = r.className ? r.className : 'rank';
}

/* ============================================================================
   utils: notify, ticker, etc.
   ============================================================================ */
function notify(txt, timeout=4000){ const n = document.getElementById('notify'); n.textContent = txt; n.style.display='block'; setTimeout(()=> n.style.display='none', timeout); }
function addTicker(text){
  const current = tickerTrack.textContent || '';
  const parts = current.split('  ‚Ä¢  ').filter(Boolean);
  parts.push(text);
  while(parts.length>60) parts.shift();
  tickerTrack.textContent = parts.join('  ‚Ä¢  ');
}
function seedTicker(){ const arr=[]; for(let i=0;i<1;i++) arr.push(`${sample(NAMES)} v·ª´a r√∫t ${fmt(rnd(10_000_000,8_000_000_000))} ƒë`); tickerTrack.textContent = arr.join('  ‚Ä¢  '); }
function startTicker(){ if(tickerInterval) clearInterval(tickerInterval); tickerInterval = setInterval(()=>{ const t=rnd(1,3); if(t===1) addTicker(`${sample(NAMES)} v·ª´a r√∫t ${fmt(rnd(10_000_000,8_000_000_000))} ƒë`); else if(t===2) addTicker(`${sample(NAMES)} v·ª´a ƒë·∫∑t ${fmt(rnd(10000,5_000_000))} ƒë v√†o ${sample(['T√†i','X·ªâu','Ch·∫µn','L·∫ª'])}`); else addTicker(`${sample(NAMES)} v·ª´a th·∫Øng ${fmt(rnd(1_000_000,500_000_000))} ƒë`); }, TICKER_INTERVAL_MS); }

/* ============================================================================
   Init / Boot
   ============================================================================ */
function initUI(){
  renderBalance(); renderChips(); setupBetGrid(); renderHistory(); buildTopWithdraws(); seedTicker(); startTicker(); randomizeStats();
  document.getElementById('cskhBtn').addEventListener('click', ()=> document.getElementById('cskhPopup').style.display='block');
  document.getElementById('cskhClose').addEventListener('click', ()=> document.getElementById('cskhPopup').style.display='none');
  setInterval(()=> nowClock.textContent = new Date().toLocaleTimeString('vi-VN',{hour12:false}), 1000);
  setTimeout(()=> startRound(), 400);
}
initUI();

window.addEventListener('beforeunload', ()=> saveState());
</script>
</body>
</html>
<!-- filler 0001 -->
<!-- filler 0002 -->
<!-- filler 0003 -->
<!-- filler 0004 -->
<!-- filler 0005 -->
<!-- filler 0006 -->
<!-- filler 0007 -->
<!-- filler 0008 -->
<!-- filler 0009 -->
<!-- filler 0010 -->
<!-- filler 0011 -->
<!-- filler 0012 -->
<!-- filler 0013 -->
<!-- filler 0014 -->
<!-- filler 0015 -->
<!-- filler 0016 -->
<!-- filler 0017 -->
<!-- filler 0018 -->
<!-- filler 0019 -->
<!-- filler 0020 -->
<!-- filler 0021 -->
<!-- filler 0022 -->
<!-- filler 0023 -->
<!-- filler 0024 -->
<!-- filler 0025 -->
<!-- filler 0026 -->
<!-- filler 0027 -->
<!-- filler 0028 -->
<!-- filler 0029 -->
<!-- filler 0030 -->
<!-- filler 0031 -->
<!-- filler 0032 -->
<!-- filler 0033 -->
<!-- filler 0034 -->
<!-- filler 0035 -->
<!-- filler 0036 -->
<!-- filler 0037 -->
<!-- filler 0038 -->
<!-- filler 0039 -->
<!-- filler 0040 -->
<!-- filler 0041 -->
<!-- filler 0042 -->
<!-- filler 0043 -->
<!-- filler 0044 -->
<!-- filler 0045 -->
<!-- filler 0046 -->
<!-- filler 0047 -->
<!-- filler 0048 -->
<!-- filler 0049 -->
<!-- filler 0050 -->
<!-- filler 0051 -->
<!-- filler 0052 -->
<!-- filler 0053 -->
<!-- filler 0054 -->
<!-- filler 0055 -->
<!-- filler 0056 -->
<!-- filler 0057 -->
<!-- filler 0058 -->
<!-- filler 0059 -->
<!-- filler 0060 -->
<!-- filler 0061 -->
<!-- filler 0062 -->
<!-- filler 0063 -->
<!-- filler 0064 -->
<!-- filler 0065 -->
<!-- filler 0066 -->
<!-- filler 0067 -->
<!-- filler 0068 -->
<!-- filler 0069 -->
<!-- filler 0070 -->
<!-- filler 0071 -->
<!-- filler 0072 -->
<!-- filler 0073 -->
<!-- filler 0074 -->
<!-- filler 0075 -->
<!-- filler 0076 -->
<!-- filler 0077 -->
<!-- filler 0078 -->
<!-- filler 0079 -->
<!-- filler 0080 -->
<!-- filler 0081 -->
<!-- filler 0082 -->
<!-- filler 0083 -->
<!-- filler 0084 -->
<!-- filler 0085 -->
<!-- filler 0086 -->
<!-- filler 0087 -->
<!-- filler 0088 -->
<!-- filler 0089 -->
<!-- filler 0090 -->
<!-- filler 0091 -->
<!-- filler 0092 -->
<!-- filler 0093 -->
<!-- filler 0094 -->
<!-- filler 0095 -->
<!-- filler 0096 -->
<!-- filler 0097 -->
<!-- filler 0098 -->
<!-- filler 0099 -->
<!-- filler 0100 -->
<!-- filler 0101 -->
<!-- filler 0102 -->
<!-- filler 0103 -->
<!-- filler 0104 -->
<!-- filler 0105 -->
<!-- filler 0106 -->
<!-- filler 0107 -->
<!-- filler 0108 -->
<!-- filler 0109 -->
<!-- filler 0110 -->
<!-- filler 0111 -->
<!-- filler 0112 -->
<!-- filler 0113 -->
<!-- filler 0114 -->
<!-- filler 0115 -->
<!-- filler 0116 -->
<!-- filler 0117 -->
<!-- filler 0118 -->
<!-- filler 0119 -->
